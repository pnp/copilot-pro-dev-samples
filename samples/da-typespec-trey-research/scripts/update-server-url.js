#!/usr/bin/env node

const fs = require('fs');
const path = require('path');

/**
 * Script to update the SERVER_URL constant in server-config.tsp to match OPENAPI_SERVER_URL environment variable
 */

function updateServerUrl() {
    const envFilePath = path.join(__dirname, '..', 'env', '.env.local');
    const serverConfigFilePath = path.join(__dirname, '..', 'server-config.tsp');

    // Check if environment file exists
    if (!fs.existsSync(envFilePath)) {
        console.error('Error: .env.local file not found at', envFilePath);
        process.exit(1);
    }

    try {
        // Read environment file
        const envContent = fs.readFileSync(envFilePath, 'utf8');

        // Extract OPENAPI_SERVER_URL value
        const openApiUrlMatch = envContent.match(/^OPENAPI_SERVER_URL=(.+)$/m);
        if (!openApiUrlMatch) {
            console.error('Error: OPENAPI_SERVER_URL not found in .env.local');
            process.exit(1);
        }

        const openApiUrl = openApiUrlMatch[1].trim();
        const serverUrl = `${openApiUrl}/api`;

        // Generate server-config.tsp content
        const serverConfigContent = `/**
 * Server configuration - Generated file, do not edit manually
 * This file is automatically generated from environment variables
 */

/**
 * The base URL for the API.
 */
const SERVER_URL = "${serverUrl}";
`;

        // Write to server-config.tsp file
        fs.writeFileSync(serverConfigFilePath, serverConfigContent, 'utf8');
        console.log(`âœ… Updated SERVER_URL to: ${serverUrl}`);

    } catch (error) {
        console.error('Error updating server URL:', error.message);
        process.exit(1);
    }
}

// Run the script
updateServerUrl();
